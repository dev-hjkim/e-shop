<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.eshop.auth.repository.AuthRepository">
    <select id="isDuplicatedId" parameterType="String" resultType="boolean">
        SELECT EXISTS(SELECT user_id
                      FROM tb_member
                      WHERE 1=1
                        AND user_id=#{userId})
    </select>

    <insert id="signin" parameterType="UserEntity">
        INSERT INTO tb_member (
        user_id
        , name
        , join_cd
        , status
        , password
        , tel
        , post_num
        , address
        , noti_yn
        , noti_agree_dt
        , last_login_dt
        , modify_pw_dt
        , reg_dt
        , upd_dt
        )
        VALUES (
        #{userId}
        , #{name}
        , #{joinCode}
        , #{status}
        , #{password}
        , #{tel}
        , #{postNum}
        , #{address}
        , #{notiYn}
        , now()
        , now()
        , now()
        , now()
        , now()
        )
    </insert>

    <select id="findUserByUserId" parameterType="String" resultType="UserEntity">
        SELECT user_no
             , user_id
             , password
        FROM tb_member
        WHERE 1=1
          AND user_id = #{userId}
    </select>

    <select id="findAccessTokenByUserNo" parameterType="long" resultType="TokenEntity">
        SELECT token_no
             , user_no
             , token
             , expire_dt
             , reg_dt
             , upd_dt
        FROM tb_token
        WHERE 1=1
          AND user_no = #{userNo}
          AND linked_token_no is null
          AND expire_dt <![CDATA[>=]]> now()
    </select>

    <select id="findRefreshTokenByLinkedTokenNo" parameterType="long" resultType="TokenEntity">
        SELECT token_no
             , user_no
             , token
             , expire_dt
             , reg_dt
             , upd_dt
        FROM tb_token
        WHERE 1=1
          AND linked_token_no = #{tokenNo}
    </select>

    <select id="findAccessTokenByRandomToken" resultType="TokenEntity">
        SELECT token_no
             , user_no
             , token
             , expire_dt
             , reg_dt
             , upd_dt
        FROM tb_token
        WHERE 1=1
          AND token = #{token}
    </select>

    <select id="findRefreshTokenByRandomToken" resultType="TokenEntity">
        SELECT token_no
             , user_no
             , token
             , expire_dt
             , reg_dt
             , upd_dt
        FROM tb_token
        WHERE 1=1
          AND token = #{token}
    </select>

    <insert id="insertAccessToken" parameterType="TokenEntity">
        INSERT INTO tb_token (
                              user_type
                            , user_no
                            , linked_token_no
                            , token
                            , expire_dt
                            , reg_dt
                            , upd_dt
        ) VALUES (
                    #{userType}
                  , #{userNo}
                  , null
                  , #{token}
                  , #{expireDt}
                  , now()
                  , now()
        )
        <selectKey resultType="long" keyProperty="tokenNo" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
    </insert>

    <insert id="insertRefreshToken" parameterType="TokenEntity">
        INSERT INTO tb_token (
                                user_type
                                , user_no
                                , linked_token_no
                                , token
                                , expire_dt
                                , reg_dt
                                , upd_dt
        ) VALUES (
                    #{userType}
                    , #{userNo}
                    , #{linkedTokenNo}
                    , #{token}
                    , #{expireDt}
                    , now()
                    , now()
        )
    </insert>

    <select id="findUserByUserNo" parameterType="long" resultType="UserEntity">
        SELECT user_no
             , user_id
        FROM tb_member
        WHERE 1=1
          AND user_no = #{userNo}
    </select>

    <update id="updateExpireDt" parameterType="long">
        UPDATE tb_token
           SET expire_dt = now()
             , upd_dt = now()
         WHERE 1=1
           AND user_no = #{userNo}
           AND expire_dt <![CDATA[>=]]> now()
    </update>
</mapper>