<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.eshop.member.auth.repository.AuthRepository">
    <select id="findAccessTokenByUserNo" parameterType="long" resultType="TokenEntity">
        SELECT token_no
             , user_no
             , random_access_token
             , access_expire_dt
             , reg_dt
             , upd_dt
        FROM tb_token3
        WHERE 1=1
          AND user_no = #{userNo}
    </select>

    <select id="findAccessTokenByRandomToken" resultType="TokenEntity">
        SELECT token_no
             , user_no
             , random_access_token
             , access_expire_dt
             , reg_dt
             , upd_dt
        FROM tb_token3
        WHERE 1=1
          AND random_access_token = #{randomToken}
    </select>

    <select id="findRefreshTokenByRandomToken" resultType="TokenEntity">
        SELECT token_no
             , user_no
             , random_refresh_token
             , refresh_expire_dt
             , reg_dt
             , upd_dt
        FROM tb_token3
        WHERE 1=1
          AND random_refresh_token = #{randomToken}
    </select>

    <insert id="upsertToken" parameterType="TokenEntity">
        INSERT INTO tb_token3 (
                              user_type
                            , user_no
                            , random_access_token
                            , access_expire_dt
                            , random_refresh_token
                            , refresh_expire_dt
                            , reg_dt
                            , upd_dt
        ) VALUES (
                    #{userType}
                  , #{userNo}
                  , #{randomAccessToken}
                  , #{accessExpireDt}
                  , #{randomRefreshToken}
                  , #{refreshExpireDt}
                  , now()
                  , now()
        )
        ON DUPLICATE KEY
        UPDATE
              random_access_token = #{randomAccessToken}
            , access_expire_dt = now()
            , random_refresh_token = #{randomRefreshToken}
            , refresh_expire_dt = now()
            , upd_dt = now()
    </insert>
</mapper>